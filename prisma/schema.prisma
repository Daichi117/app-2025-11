generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. ユーザー
model User {
  id              String           @id @default(uuid())
  email           String           @unique
  name            String
  password_hash   String
  base_currency   String           @default("JPY")
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  categories      Category[]
  financial_items FinancialItem[]
  simulations     Simulation[]
  // エラー解消ポイント: 下記の InvestmentGoal モデルと名前を完全に一致させる
  investment_goals InvestmentGoal[] 
  ai_proposals    AIProposal[]
  risk_profile    RiskAssessment?
  portfolios      Portfolio[]
  learning_logs   LearningProgress[]
  auth_logs       auth_logs[]
  refresh_tokens  refresh_tokens[]

  @@index([email])
  @@map("users")
}

// 2. カテゴリー
model Category {
  id        String   @id @default(uuid())
  user_id   String
  name      String   
  type      String   // INCOME, EXPENSE, ASSET, LIABILITY
  color     String?  
  icon      String?  
  parent_id String?  
  
  financial_items FinancialItem[]
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("categories")
}

// 3. 家計・資産明細
model FinancialItem {
  id              String   @id @default(uuid())
  user_id         String
  category_id     String
  amount          Decimal  
  currency        String   @default("JPY")
  exchange_rate   Decimal  @default(1.0)
  date            DateTime 

  source          String   @default("MANUAL") 
  external_id     String?  @unique            
  frequency       String   @default("ONE_TIME") 
  is_estimated    Boolean  @default(false)      
  
  description     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user            User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  category        Category        @relation(fields: [category_id], references: [id])
  liability_info  LiabilityDetail? 

  @@index([user_id, date])
  @@map("financial_items")
}

// 4. 負債詳細
model LiabilityDetail {
  id                String   @id @default(uuid())
  financial_item_id String   @unique
  interest_rate     Decimal  
  repayment_type    String   
  term_months       Int      
  
  financial_item    FinancialItem @relation(fields: [financial_item_id], references: [id], onDelete: Cascade)
  @@map("liability_details")
}

// 5. 投資ポートフォリオ
model Portfolio {
  id          String   @id @default(uuid())
  user_id     String
  name        String   @default("Main Portfolio")
  is_active   Boolean  @default(true)
  
  holdings    Holding[]
  transactions Transaction[]
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("portfolios")
}

model Holding {
  id            String   @id @default(uuid())
  portfolio_id  String
  symbol        String   
  asset_class   String   
  currency      String   @default("USD")
  quantity      Decimal
  average_cost  Decimal
  current_price Decimal
  last_sync_at  DateTime @default(now()) 

  portfolio     Portfolio @relation(fields: [portfolio_id], references: [id], onDelete: Cascade)
  @@unique([portfolio_id, symbol])
  @@map("holdings")
}

model Transaction {
  id             String   @id @default(uuid())
  portfolio_id   String
  type           String   
  symbol         String
  quantity       Decimal
  price          Decimal  
  fee            Decimal  @default(0)
  date           DateTime @default(now())

  portfolio      Portfolio @relation(fields: [portfolio_id], references: [id], onDelete: Cascade)
  @@map("transactions")
}

// 6. AI & 目標 & シミュレーション
model AIProposal {
  id                String   @id @default(uuid())
  user_id           String
  type              String   
  status            String   @default("PENDING") 
  context_snapshot  Json     
  proposal_data     Json     
  rationale         String   @db.Text 
  impact_score      Decimal? 
  execution_date    DateTime?

  created_at        DateTime @default(now())
  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("ai_proposals")
}

model Simulation {
  id           String   @id @default(uuid())
  user_id      String
  name         String?
  inputs       Json     
  results      Json     
  created_at   DateTime @default(now())

  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  @@map("simulations")
}

// エラー解消ポイント: モデル名を正確に定義
model InvestmentGoal {
  id            String   @id @default(uuid())
  user_id       String
  title         String   
  target_amount Decimal
  target_date   DateTime
  current_progress Decimal @default(0)

  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  @@map("investment_goals")
}

model RiskAssessment {
  id            String   @id @default(uuid())
  user_id       String   @unique
  score         Int
  risk_type     String
  answers       Json
  expires_at    DateTime 
  updated_at    DateTime @updatedAt

  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  @@map("risk_assessments")
}

// 7. ログ・進捗
model LearningProgress {
  id          String   @id @default(uuid())
  user_id     String
  content_id  String
  status      String   
  last_read   DateTime @default(now())

  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  @@map("learning_progress")
}

model auth_logs {
  id         String   @id @default(uuid())
  user_id    String
  success    Boolean
  ip_address String?
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model refresh_tokens {
  id         String   @id @default(uuid())
  user_id    String
  token      String   @unique
  expires_at DateTime
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}