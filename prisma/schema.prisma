
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ユーザー（ログイン・認証の基点）
 */
// --- 1. ユーザー：設定と属性 ---
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String
  birthday      DateTime? 
  riskProfile   String    @default("NORMAL") // ★ AI提案に使うリスク許容度 (LOW, NORMAL, HIGH)
  createdAt     DateTime  @default(now())

  categories    Category[]
  transactions  Transaction[]
  assets        Asset[]
  assetSnapshots AssetSnapshot[] // ★ グラフ用の履歴
  simulations   Simulation[]
  @@map("users")
}

// --- 2. カテゴリー：収支の分類 ---
model Category {
  id           String    @id @default(uuid())
  userId       String
  name         String    
  type         String    // "INCOME" or "EXPENSE"
  isFixedCost  Boolean   @default(false)

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  @@unique([userId, name])
  @@map("categories")
}

// --- 3. 取引：日々の家計簿 ---
model Transaction {
  id          String    @id @default(uuid())
  userId      String
  categoryId  String
  amount      Decimal   @db.Decimal(12, 2)
  date        DateTime  @default(now())
  description String?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category  @relation(fields: [categoryId], references: [id])
  @@index([userId, date])
  @@map("transactions")
}

// --- 4. 資産：現在の「持ち物」 ---
model Asset {
  id          String    @id @default(uuid())
  userId      String
  assetType   String    // "CASH", "STOCK", "BOND"
  name        String    // 例: eMAXIS Slim 米国株式
  symbol      String?   // ★ 銘柄コード (VOO, 2558など) AIが分析しやすくなる
  balance     Decimal   @db.Decimal(12, 2)
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("assets")
}

// --- 5. 資産スナップショット：グラフ用履歴 ---
model AssetSnapshot {
  id          String    @id @default(uuid())
  userId      String
  date        DateTime  @default(now()) // 記録日
  totalAmount Decimal   @db.Decimal(16, 2) // その日の総資産額
  cashAmount  Decimal   @db.Decimal(16, 2) // その日の現金合計
  investAmount Decimal  @db.Decimal(16, 2) // その日の投資合計

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, date])
  @@map("asset_snapshots")
}

// --- 6. シミュレーション & AI戦略 ---
model Simulation {
  id                String   @id @default(uuid())
  userId            String
  targetAmount      Decimal  @db.Decimal(16, 2)
  targetAge         Int      
  requiredAnnualRate Float   
  dailyIncomeTarget  Decimal @db.Decimal(12, 2)
  difficulty         String  
  aiStrategyJson     Json?    // AIが提案したポートフォリオ(割合や銘柄)

  createdAt          DateTime @default(now())
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("simulations")
}